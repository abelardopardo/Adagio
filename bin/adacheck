#!/bin/bash
#
# Copyright (C) 2008 Carlos III University of Madrid
# This file is part of the ADA: Agile Distributed Authoring Toolkit

# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor
# Boston, MA  02110-1301, USA.

#
#
# Script to simply invoke adado to check which tools are installed.
#

# Function use to make sure ADA_HOME is set, if not, suggest the steps to do
# so. VERY important the message including the $ADA_REAL_USER_HOME variable. For
# ant this variable points to C:\Documents and Settings\username, whereas for
# cygwin $HOME points to some location within its internal tree (/home/...)
function ada_check_home() {
    if [ "$ADA_HOME" = "" ]; then
	echo "ERROR: Unable to set variable ADA_HOME"
	echo "Edit the file .ant.properties in $ADA_REAL_USER_HOME and"
        echo "add a line such as:"
	if [ "$cygwin" = "true" ]; then
	    echo "ada.home="`cygpath --windows /`"\[path to your ADA installation]\ADA"
	else
	    echo "ada.home=[path to your ADA dir]"
	fi
	exit
    fi
}

cygwin=false;
case "`uname`" in
    CYGWIN*) cygwin=true ;;
esac

ADA_HOME=`dirname $0`/..
if [ $cygwin = "true" ]; then
    # If within cygwin, pahts need to be manipulated for a correct ant
    # invocation

    # If ADA_HOME is empty, bomb out with msg
    ada_check_home

    ADA_HOME=`cygpath --windows $ADA_HOME`
    ADA_HOME=${ADA_HOME//\\/\\\\}
fi

# Slurp some additional functions
source $ADA_HOME/bin/functions.bash
ada_version

# Set the dirs with the catalogs to be checked
export XML_CATALOG_FILES="$ADA_HOME/DTDs/catalog"

echo
echo "ADA: Agile Distributed Authoring Toolkit (Version $ada_version)"
echo "Copyright (C) 2008 Carlos III University of Madrid"
echo

# TEST 1: Docbook properly installed
echo -n "TEST  1: Docbook DTDs and XSLs are properly installed... "
xsltproc \
    --nonet \
    --path \
    ".:$ADA_HOME/ADA_Styles" \
    "--xinclude" \
    "--stringparam" \
    "ada.home" \
    "$ADA_HOME" \
    "--stringparam" \
    "basedir" \
    "$ADA_HOME/doc" \
    "--stringparam" \
    "ada.course.home" \
    "./" \
    "--stringparam" \
    "ada.current.datetime" \
    "" \
    "--stringparam" \
    "profile.revision" \
    "" \
    "--stringparam" \
    "chapter.autolabel" \
    "0" \
    "--stringparam" \
    "section.autolabel" \
    "1" \
    "--stringparam" \
    "section.toc.depth" \
    "0" \
    "--stringparam" \
    "html.stylesheet" \
    "style.css" \
    "--stringparam" \
    "ada.version" \
    "$ada_version" \
    "-o" \
    "$ADA_HOME/doc/FAQ.html" \
    "$ADA_HOME/doc/QandaentryTable.xsl" \
    "$ADA_HOME/doc/FAQ.xml" 1>/dev/null 2>&1

adaXsltprocStatus="$?"
if [ $adaXsltprocStatus -ne 0 ]; then
    echo
    echo
    echo "************************* WARNING *************************"
    echo
    echo "Your system does not appear to have the DTD catalogs properly"
    echo "installed. These catalogs prevent Xsltproc from fetching all the"
    echo "required style and DTD files from their remote locations (through"
    echo "URLs) and instead use local copies. The catalog file is usually in"
    echo "/etc/xml/catalog and managed automatically by package"
    echo "installers. However, if this file is not available you need to have"
    echo "this definitions inserted manually in the file "
    echo  "$ADA_HOME/catalog."
    echo "If these catalog files are not properly installed, stylesheet processing"
    echo "will be extremely slow (because all the imported style sheets are"
    echo "fetched from the net)."
    echo
    echo "************************************************************"
    echo
    exit
else
    echo "OK"
fi

# TEST 2: "matches" (included in ant-optional is available
#
# Execute SampleCourses/Admin/Laboratory2
#
echo -n "TEST  2: 'match' condition can be used ................. "
ant -q -Dada.home="$ADA_HOME" \
    -Dada.version="$ada_version" \
    -Dexportcontrol.files.given=true \
    -Dexportcontrol.profile.revision="Lab1,Lab2,Lab3" \
    -Dbasedir="$ADA_HOME/SampleCourse/Admin/Laboratory2" \
    -f "$ADA_HOME/AntImports/ExportControl.xml" 1>/dev/null 2>&1

adaXsltprocStatus="$?"
if [ $adaXsltprocStatus -ne 0 ]; then
    echo
    echo
    echo "************************* WARNING *************************"
    echo
    echo "Your system does not appear to have the ant-optional library."
    echo "Install it and re-run this test."
    echo
    echo "************************************************************"
    echo
    exit
else
    echo "OK"
fi

echo
adado -Dada.property.file.ready=true report
