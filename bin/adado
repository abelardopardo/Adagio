#!/bin/bash
#
# Copyright (C) 2008 Carlos III University of Madrid
# This file is part of the ADA: Agile Distributed Authoring Toolkit

# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor
# Boston, MA  02110-1301, USA.

#
# Script to set the proper variables for ADA to be available for execution
#

# Function use to make sure ADA_HOME is set, if not, suggest the steps to do
# so. VERY important the message including the $ADA_REAL_USER_HOME variable. For
# ant this variable points to C:\Documents and Settings\username, whereas for
# cygwin $HOME points to some location within its internal tree (/home/...)
function ada_check_home() {
    if [ "$ADA_HOME" = "" ]; then
	echo "ERROR: Unable to set variable ADA_HOME"
	echo "Edit the file .ant.properties in $ADA_REAL_USER_HOME and"
        echo "add a line such as:"
	if [ "$cygwin" = "true" ]; then
	    echo "ada.home="`cygpath --windows /`"\[path to your ADA installation]\ADA"
	else
	    echo "ada.home=[path to your ADA dir]"
	fi
	exit
    fi
}

function ada_check_catalog() {
    if [ ! -w $ADA_HOME/DTDs ]; then
        echo "Permission error. Need to have rw access to $ADA_HOME/DTDs"
        exit
    fi
    if [ ! -f $ADA_HOME/DTDs/catalog ]; then
	sed -e "s:@ADA_HOME_DTD@:$ADA_HOME/DTDs:" $ADA_HOME/DTDs/catalog.template \
	    > $ADA_HOME/DTDs/catalog
    fi
}

cygwin=false;
case "`uname`" in
    CYGWIN*) cygwin=true ;;
esac

# Get basic variables
basedir=$PWD

# If within cygwin, pahts need to be manipulated for a correct ant invocation
if [ $cygwin = "true" ]; then
    
    ADA_HOME=`dirname $0`/..

    # If ADA_HOME is empty, bomb out with msg
    ada_check_home

    ADA_HOME=`cygpath --windows $ADA_HOME`
    ADA_HOME=${ADA_HOME//\\/\\\\}
    
    # Set path to Alltargets also in windows syntax with double fwdslash
    AllTargets=`cygpath --windows $ADA_HOME/AntImports/AllTargets.xml`
    AllTargets=${AllTargets//\\/\\\\}
    
    # Set basedir also in windows syntax with double fwdslash
    basedir=`cygpath --windows $basedir`
    basedir=${basedir//\\/\\\\}
else
    # Not in cygwin, directly fetch ADA_HOME from the path used to invoke the script
    ADA_HOME=`dirname $0`/..

    AllTargets="$ADA_HOME/AntImports/AllTargets.xml"
fi

# If ADA_HOME is empty, bomb out with msg
ada_check_home

# Slurp some additional functions
source $ADA_HOME/bin/functions.bash
ada_version

# Make sure catalog exists
ada_check_catalog
XML_CATALOG_FILES="file://$ADA_HOME/DTDs/catalog"

# Invoke ant
rm -f adado.log
echo "ada_version=$ada_version" > adado.log
echo "XML_CATALOG_FILES is $XML_CATALOG_FILES" >> adado.log
ant -q -Dada.home="$ADA_HOME" \
    -q -Dada.version="$ada_version" \
    -Dbasedir="$basedir" \
    -f "$AllTargets" $* 2>> adado.log

# Check for status: 0 = OK, 1 = Something went wrong!
adaAntStatus="$?"
if [ $adaAntStatus -ne 0 ]; then
    # In adado.log there is a ADA_BEGIN_EXE and ADA_END_EXE when ADA
    # entries/leaves a directory. Process those messages to find out in which
    # directory the error has occurred.
    context=()
    while read line; do
        case $line in
	    # Push begin line to the array
            ADA_BEGIN_EXE*)
                context[${#context[@]}]="$line"
                ;;
	    # Pop end line off the array
            ADA_END_EXE*)
                previous=`expr ${#context[@]} - 1`
                unset context[$previous]
                ;;
        esac
    done < adado.log

    # Dump the path to the proper file to check
    errorFile="build.out"
    if [ ${#context[@]} -eq 1 ]; then
	errorDir="."
    else
	# The error occurred in the dir contained in the last array value
        previous=`expr ${#context[@]} - 1`
	errorDir=`expr match "${context[$previous]}" "ADA_BEGIN_EXE \(.*\)"`
    fi

    # It might be the case such that build.out does not exist. This means an ANT
    # error. Redirect
    if [ ! -f $errorDir/$errorFile ]; then
	errorDir="."
	errorFile="adado.log"
    else
	# If adado.log contains no relevant info, nuke it.
	rm -f adado.log
    fi
    echo
    echo "---------------------------------- ADA ERROR ----------------------------------"
    echo
    echo "-- Full error information in file:"
    echo "   $errorDir/$errorFile"
    echo 
    echo "                            ==== Error excerpt ===="
    head $errorDir/$errorFile 2>/dev/null
    echo "                            ======================="
    echo
    echo "-------------------------------------------------------------------------------"
    echo
else
    # If ant finished successfuly, no need to keep adado.log around
    rm -f adado.log
fi

exit

