<?xml version="1.0" encoding="UTF-8"?>

<project name="Copy files from SRC to DST" default="copyfiles">

  <!--
      Given the following properties:

      copyfiles.files:   List of files to copy from src to dst
      copyfiles.src.dir: source directory to obtain the files
      copyfiles.dst.dir: directory where the files are to be copied

      copies copyfiles.files in copy.src.dir to copyfiles.dst.dir. The copy is
      performed only if the two dirs are non empty.
  -->

  <!-- Checks for availability of different binaries -->
  <import file="InitialCheck.xml"/>

  <!-- Property definition -->
  <property name="copyfiles.src.dir"      value="${basedir}" />
  <property name="copyfiles.dst.dir"      value="${copyfiles.src.dir}" />
  <property name="copyfiles.files"        value=""/>

  <!-- Source files to be copied. -->
  <fileset id="copyfiles.fileset" dir="${copyfiles.src.dir}"
	   includes="${copyfiles.files}"/>

  <!-- Preliminary target to verify that certain minimum conditions hold before
  executing the regular targets. -->
  <target name="copyfiles.check.values" 
	  depends="initial.check, copyfiles.dump.properties">

    <!-- Condition to enable/disable the rest of the execution -->
    <condition property="copyfiles.check">
      <and>
	<!-- The src.dir needs to be non-empty. It is very dangerous to have an
	     empty definition of this variable. At least a . needs to be present -->
	<not><equals arg1="${copyfiles.src.dir}" arg2=""/></not>
	<!-- There must be some files defined -->
	<not><equals arg1="${copyfiles.files}" arg2=""/></not>
	<!-- Require a non-empty dst.dir as well -->
	<not><equals arg1="${copyfiles.dst.dir}" arg2=""/></not>
	<!-- SRC and DST directories must be different -->
	<not>
	  <equals arg1="${copyfiles.dst.dir}" arg2="${copyfiles.src.dir}"/>
	</not>
      </and>
    </condition>

    <!-- Dump the value of the properties just computed. -->
    <echo level="info">    copyfiles.check          = "${copyfiles.check}"
    copyfiles.fileset         = "${copyfiles.files}"</echo>
  </target>

  <!-- Target to notify that the regular target has not been executed. This is
  to notify the user -->
  <target name="copyfiles.processing.NOT" unless="copyfiles.check">
    <echo>copyfiles.processing        ---</echo>
    <echo>${basedir}</echo>
  </target>

  <!-- Regular target. It is executed if the check property is true, and it has
  as dependency the NOT target. That way, if the property is not set, this
  target is not executed and instead, the one notifying the user of such event
  is executed. -->
  <target name="copyfiles.processing" 
	  depends="copyfiles.check.values, copyfiles.processing.NOT"
	  if="copyfiles.check" description="Actually perform the copy">

    <echo>copyfiles.processing        RUN</echo>
    <echo>${basedir}</echo>

    <!-- Create the dst directory -->
    <mkdir dir="${copyfiles.dst.dir}" />

    <!-- Execute the command. Watch out for src.dir and dst.dir -->
    <copy todir="${copyfiles.dst.dir}">
      <fileset refid="copyfiles.fileset"/>
    </copy>
  </target>

  <!-- Target to notify that the regular target has not been executed. This is
  to notify the user -->
  <target name="copyfiles.clean.NOT" unless="copyfiles.check">
    <echo>copyfiles.clean             ---</echo>
    <echo>${basedir}</echo>
  </target>

  <!-- Clean the produced files -->
  <target name="copyfiles.clean" depends="copyfiles.check.values,
					  copyfiles.clean.NOT" 
    if="copyfiles.check" description="Delete files copied to dst">

    <echo>copyfiles.clean             RUN</echo>
    <echo>${basedir}</echo>

    <!-- Obtain the fileset containing the produced files. This is done to be
    able to display the deleted files (debugging) -->
    <pathconvert property="copyfiles.target.fileset.property" pathsep=" ">
      <fileset refid="copyfiles.fileset"/>
      <mapper type="glob" from="${copyfiles.src.dir}*" to="${copyfiles.dst.dir}*"/>
    </pathconvert>
    <filelist id="copyfiles.target.fileset" 
	      files="${copyfiles.target.fileset.property}"/>

<!--     <fileset id="copyfiles.target.fileset" dir="${copyfiles.dst.dir}" -->
<!-- 	     includes="${copyfiles.target.fileset.property}"> -->
<!-- 	<include name="__bogus__file__to__avoid__empty__fileset"/> -->
<!--     </fileset> -->

    <!-- Dump explicitly the files to be deleted -->
    <echo> deleted = ${copyfiles.target.fileset.property}</echo>

    <!-- Perform the delete operation. The failonerror attributge is needed
	 and must be set fo false because the dst directory might have been
	 removed  -->
    <delete failonerror="false" includeemptydirs="true">
      <!-- Obtain the fileset containing the produced files. This is done to be
	   able to display the deleted files (debugging) -->
      <filelist refid="copyfiles.target.fileset"/>
    </delete>
  </target>

  <!-- Dump the properties defined in this script -->
  <target name="copyfiles.dump.properties" depends="initial.check">
    <echo level="info"> ------ Copyfiles properties ----
    copyfiles.src.dir ="${copyfiles.src.dir}"
    copyfiles.dst.dir ="${copyfiles.dst.dir}"
    copyfiles.files   ="${copyfiles.files}" </echo>
  </target>

  <!-- If entering through this target, build.out is deleted -->
  <target name="copyfiles" depends="initial.delete.build.out, copyfiles.processing"/>
</project>
