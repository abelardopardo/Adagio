<?xml version="1.0" encoding="UTF-8"?>

<project name="Figure Processing with inkscape" default="inkscape">

  <!--
      Given the following properties:

      inkscape.src.dir: directory from where to take the source files
      inkscape.dst.dir: directory where the translated files are stored
      inkscape.files: comma/space separated list of files to process

      Process files in fileset. They are processed by inkscape and translated
      to PNG, PDF, EPS or PS format.
  -->

  <import file="InitialCheck.xml" />

  <property name="inkscape.exec" value="inkscape"/>

  <ada.set.execution.possible ADA.EXECUTABLE.NAME="${inkscape.exec}"/>

  <!-- Private properties -->
  <property name="inkscape.debug.level"    value="${ada.debug.level}"/>
    
  <target name="inkscape.init" depends="ada.init" if="inkscape.execution.possible">
    <!-- Public Property definition -->
    <property name="inkscape.src.dir"       value="${basedir}"/>
    <property name="inkscape.dst.dir"       value="${inkscape.src.dir}"/>
    <property name="inkscape.output.format" value="png"/>
    <property name="inkscape.files"         value=""/>

    <!-- Define two properties containing the absolute src and dst paths -->
    <ada.expand.srcdst.paths
      ADA.PREFIX="inkscape" ADA.SRC.DIR="${inkscape.src.dir}"
      ADA.DST.DIR="${inkscape.dst.dir}" ADA.FILES="${inkscape.files}"/>

    <!-- Condition to enable/disable the rest of the execution -->
    <condition property="inkscape.check">
      <!-- 
	   There must be some files in the fileset (after regexp expansion)
      -->
      <not>
	<equals arg1="${inkscape.source.filelist.property}" arg2=""
		trim="true"/>
      </not>
    </condition>
    
    <!-- Dump the value of the properties just computed. -->
    <echo level="${inkscape.debug.level}">inkscape.check          = "${inkscape.check}"
inkscape.execution.possible = ${inkscape.execution.possible}</echo>

  </target>

  <!-- Regular target. It is executed if the check property is true -->
  <target name="inkscape.processing" 
	  depends="inkscape.init, inkscape.preprocessing,
		   inkscape.export.png, inkscape.export.eps,
		   inkscape.export.ps, inkscape.export.pdf"
	  description="Creates images from the SVG files"/>
  
  <target name="inkscape.preprocessing" if="inkscape.check">
    <echo>inkscape.processing         RUN</echo>
    <echo level="${inkscape.debug.level}">${basedir}</echo>

    <macrodef name="inkscape.execute">
      <attribute name="INKSCAPE.EXPORT.OPTION" />
      <sequential>
	<!-- Execute the command. Watch out for src.dir and dst.dir -->
	<apply dir="${basedir}" parallel="false" dest="${inkscape.dst.dir}"
	       append="yes" failonerror="true" executable="${inkscape.exec}" 
	       output="build.out">
	  <arg line="@{INKSCAPE.EXPORT.OPTION}"/>
	  <targetfile/>
	  <srcfile/>
	  <fileset refid="inkscape.fileset"/>
	  <!-- Mapper from source files to produced files -->
	  <mapper type="glob" from="*.svg" to="*.${inkscape.output.format}"/>
	</apply>    
      </sequential>
    </macrodef>

    <condition property="inkscape.export.format.png">
      <and>
	<istrue value="${inkscape.check}"/>
	<equals arg1="${inkscape.output.format}" arg2="png"/>
      </and>
    </condition>

    <condition property="inkscape.export.format.eps">
      <and>
	<istrue value="${inkscape.check}"/>
	<equals arg1="${inkscape.output.format}" arg2="eps"/>
      </and>
    </condition>

    <condition property="inkscape.export.format.ps">
      <and>
	<istrue value="${inkscape.check}"/>
	<equals arg1="${inkscape.output.format}" arg2="ps"/>
      </and>
    </condition>

    <condition property="inkscape.export.format.pdf">
      <equals arg1="${inkscape.output.format}" arg2="pdf"/>
    </condition>

    <!-- Create the dst directory -->
    <mkdir dir="${inkscape.dst.dir}"/>
  </target>
  
  <target name="inkscape.export.png"
	  if="inkscape.export.format.png">
    <inkscape.execute INKSCAPE.EXPORT.OPTION="--export-png"/>
  </target>
  
  <target name="inkscape.export.pdf"
	  if="inkscape.export.format.pdf">
    <inkscape.execute INKSCAPE.EXPORT.OPTION="--export-pdf"/>
  </target>
  
  <target name="inkscape.export.eps"
	  if="inkscape.export.format.eps">
    <inkscape.execute INKSCAPE.EXPORT.OPTION="--export-eps"/>
  </target>
  
  <target name="inkscape.export.ps"
	  if="inkscape.export.format.ps">
    <inkscape.execute INKSCAPE.EXPORT.OPTION="--export-ps"/>
  </target>

  <!-- Clean files produced by inkscape -->
  <target name="inkscape.clean" depends="inkscape.init"
	  if="inkscape.check" description="Remove files produced by inkscape">
    
    <echo>inkscape.clean              RUN</echo>
    <echo level="${inkscape.debug.level}">${basedir}</echo>

    <!-- Obtain the filelist with the produced files. -->
    <pathconvert property="inkscape.target.filelist.property" pathsep=" ">
      <fileset refid="inkscape.fileset"/>
      <chainedmapper>
	<mapper type="glob" from="${inkscape.abssrc.dir}/*" 
		to="${inkscape.absdst.dir}/*"/>
	<mapper type="glob" from="*.svg" to="*.${inkscape.output.format}"/>
      </chainedmapper>
    </pathconvert>

    <!-- Dump explicitly the files to be deleted -->
    <echo> deleted = ${inkscape.target.filelist.property}</echo>

    <!-- Perform the delete operation. The failonerror attribute is needed
	 and must be set fo false because the dst directory might have been
	 removed  -->
    <delete failonerror="false" includeemptydirs="true">
      <files includes="${inkscape.target.filelist.property}"/>
    </delete>
  </target>

  <!-- Dump the properties defined in this script -->
  <target name="inkscape.dump.properties" depends="ada.init">
    <echo level="${inkscape.debug.level}"> ------ Inkscape properties ----
    inkscape.exec    ="${inkscape.exec}"
    inkscape.abssrc.dir ="${inkscape.abssrc.dir}"
    inkscape.absdst.dir ="${inkscape.absdst.dir}"
    inkscape.files   ="${inkscape.files}" </echo>
  </target>

  <target name="inkscape.report.YES" depends="inkscape.init"
	  if="inkscape.execution.possible">
    <echo>Inkscape           |     *     |</echo>
  </target>

  <target name="inkscape.report.NO" depends="inkscape.init"
	  unless="inkscape.execution.possible">
    <echo>Inkscape           |           |     * (install ${inkscape.exec})</echo>
  </target>

  <target name="inkscape.report" depends="inkscape.report.YES,
				      inkscape.report.NO"/>

  <!-- If entering through this target, build.out is deleted -->
  <target name="inkscape" depends="inkscape.init, initial.delete.build.out, inkscape.processing"/>
</project>
