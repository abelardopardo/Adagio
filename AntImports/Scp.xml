<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright (C) 2008 Carlos III University of Madrid
  This file is part of the ADA: Agile Distributed Authoring Toolkit

  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
  as published by the Free Software Foundation; either version 2
  of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 51 Franklin Street, Fifth Floor
  Boston, MA  02110-1301, USA.

-->

<project name="Copy source to destination using scp" default="scp">

  <!--
      Given the following properties:

      scp.source: location from where to take the source files
      scp.destination: location where to copy these files
      scp.extra.args: Specific options for scp

      Execute scp to copy the content in source with the content in
      destination. The script is supposed to work TOTALLY in batch mode, that is
      without any password exchange. Make sure you have the public/private keys
      properly installed to bypass this step.
  -->

  <import file="InitialCheck.xml"/>

  <property name="scp.exec"                value="scp"/>

  <ada.set.execution.possible ADA.EXECUTABLE.NAME="${scp.exec}"/>

  <!-- Private properties -->
  <property name="scp.debug.level"    value="${ada.debug.level}"/>

  <target name="scp.init" depends="ada.init" if="scp.execution.possible">
    <!-- Public Property definition -->
    <property name="scp.source"      value="${basedir}"/>
    <property name="scp.destination" value="${scp.source}"/>
    <property name="scp.files"       value=""/>
    <property name="scp.extra.args"  value=""/>
    
    <!-- Condition to enable/disable the rest of the execution -->
    <condition property="scp.check">
      <and>
	<!-- The source needs to be non-empty. It is very dangerous to have an
	empty definition of this variable. At least a . needs to be present -->
        <not><equals arg1="${scp.source}" arg2="" trim="true"/></not>
        <available file="${scp.source}"/>
	<!-- There must be some files defined -->
        <not><equals arg1="${scp.files}" arg2="" trim="true"/></not>
	<!-- Require a non-empty destination as well -->
        <not><equals arg1="${scp.destination}" arg2="" trim="true"/></not>
        <available file="${scp.destination}"/>
      </and>
    </condition>

    <!-- Dump the value of the properties just computed. -->
    <echo level="${scp.debug.level}">  scp.check              = "${scp.check}"</echo>

  </target>

  <!-- Regular target. It is executed if the check property is true -->
  <target name="scp.processing" depends="scp.init"
	  if="scp.check" description="Invoke scp to perform the synchronization">

    <echo>scp.processing           RUN</echo>
    <echo level="${scp.debug.level}">${basedir}</echo>

    <!-- Execute the command. Watch out for source and destination -->
    <exec executable="${scp.exec}" failonerror="true">
      <arg value="-r"/> <!-- Work recursively by default -->
      <arg value="-q"/> <!-- Disable progress meter in case is used in batch -->
      <arg line="${scp.extra.args}"/>
      <arg value="${scp.source}"/>
      <arg value="${scp.destination}"/>
    </exec>
  </target>

  <!-- Clean files produced by scp -->
  <target name="scp.clean" depends="scp.init"
	  if="scp.check" description="Remove files produced by scp">

    <!-- No action here because is a too high level procedure. Removing the
    destination dir is probably not that frequent, and therefore can be done
    manually -->
    <echo>scp.clean           NOT RUN!</echo>
    <echo level="${scp.debug.level}">${basedir}</echo>
    
  </target>
  
  <!-- Dump the properties defined in this script -->
  <target name="scp.dump.properties" depends="scp.init">
    <echo level="${scp.debug.level}">------ scp properties ----
 scp.exec                =${scp.exec}
 scp.source              =${scp.source}
 scp.destination         =${scp.destination}
 scp.extra.args          =${scp.extra.args}
 scp.basic.args          =${scp.basic.args}</echo>
  </target>

  <!-- If entering through this target, build.out is deleted -->
  <target name="scp" depends="initial.delete.build.out, scp.processing"/>
</project>
