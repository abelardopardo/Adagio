<?xml version="1.0" encoding="UTF-8"?>

<project name="Calculate if a Time Window is active or not"
	 default="timewindow">

<!--
    Given the following properties:
    
    timewindow.start: Date/time when the window of validity starts
    timewindow.end: Date/time when the window of validity ends
    timewindow.now: Date/time to be considered as the actual one
    timewindow.format: Any SimpleDateFormat pattern
    timewindow.enabled: If this functionality is activated
    timewindow.open: Set if the current time is within the window

    The timewindow target computes the value of the timewindow.open variable. If
    timewindow.enabled is true and the current time is within the limits
    (variables start and end). If enabled is false, then the variable is set to
    true with no comparison.
-->

  <!-- Public Property definition -->
  <property name="timewindow.start" value=""/>
  <property name="timewindow.end" value=""/>
  <property name="timewindow.now" value=""/>
  <property name="timewindow.format" value="yyyy-MM-dd'T'HH:mm:ss"/>
  <property name="timewindow.enabled" value="false"/>

  <!-- Private properties -->
  <property name="timewindow.now.filename" value=".ada.timewindow.now"/>
  <property name="timewindow.start.filename" value=".ada.timewindow.start"/>
  <property name="timewindow.end.filename" value=".ada.timewindow.end"/>

  <condition property="timewindow.start.defined">
    <and>
      <not><equals arg1="${timewindow.start}" arg2=""/></not>
      <equals arg1="${timewindow.enabled}" arg2="true"/>
    </and>
  </condition>

  <condition property="timewindow.end.defined">
    <and>
      <not><equals arg1="${timewindow.end}" arg2=""/></not>
      <equals arg1="${timewindow.enabled}" arg2="true"/>
    </and>
  </condition>

  <condition property="timewindow.now.defined">
    <and>
      <not><equals arg1="${timewindow.now}" arg2=""/></not>
      <equals arg1="${timewindow.enabled}" arg2="true"/>
    </and>
  </condition>

  <target name="timewindow" 
	  depends="timewindow.create.now.file,
		   timewindow.touch.now.file,
		   timewindow.check.start, 
		   timewindow.check.end"
	  if="timewindow.enabled">

    <echo level="info">timewindow.enabled=${timewindow.enabled}
timewindow.now=${timewindow.now}
timewindow.start=${timewindow.start}
timewindow.start.uptodate=${timewindow.start.uptodate}
timewindow.end=${timewindow.end}
timewindow.end.uptodate=${timewindow.end.uptodate}</echo>

    <!-- Condition
	 (!enabled) or
         ( (start = NULL or Uptodate(start, NOW))
           and
           (end = NULL or Uptodate(NOW, end))
         )
    -->
    <condition property="timewindow.open">
      <or>
	<not><equals arg1="${timewindow.enabled}" arg2="true"/></not>
	<and>
	  <or>
	    <equals arg1="${timewindow.start}" arg2=""/>
	    <isset property="timewindow.start.uptodate"/>
	  </or>
	  <or>
	    <equals arg1="${timewindow.end}" arg2=""/>
	    <isset property="timewindow.end.uptodate"/>
	  </or>
	</and>
      </or>
    </condition>

    <delete file="${timewindow.now.filename}"/>
    <echo level="info">timewindow.open = ${timewindow.open}</echo>
  </target>

  <!-- 
       Create the now filename with no date specified if no value has been given
       in the variable timewindow.now
  -->
  <target name="timewindow.create.now.file"
	  unless="timewindow.now.defined">
    <!-- Create the file with the NOW timestamp -->
    <touch file="${timewindow.now.filename}"/>
  </target>

  <!-- 
       Create the now filename with the date specified in the variable
       timewindow.now
  -->
  <target name="timewindow.touch.now.file"
	  if="timewindow.now.defined">
    <!-- Create the file with the NOW timestamp -->
    <touch datetime="${timewindow.now}"
	   file="${timewindow.now.filename}"
	   pattern="${timewindow.format}"/>
  </target>

  <!-- Set the property timewindow.start.uptodate if start < NOW -->
  <target name="timewindow.check.start"
	  if="timewindow.start.defined">


    <touch datetime="${timewindow.start}"
	   file="${timewindow.start.filename}"
	   pattern="${timewindow.format}"/>

    <uptodate property="timewindow.start.uptodate"
	      srcfile="${timewindow.start.filename}"
	      targetfile="${timewindow.now.filename}"/>

    <delete file="${timewindow.start.filename}"/>
  </target>

  <!-- Set the property timewindow.start.uptodate if NOW < end -->
  <target name="timewindow.check.end"
	  if="timewindow.end.defined">

    <touch datetime="${timewindow.end}"
	   file="${timewindow.end.filename}"
	   pattern="${timewindow.format}"/>

    <uptodate property="timewindow.end.uptodate"
	      srcfile="${timewindow.now.filename}"
	      targetfile="${timewindow.end.filename}"/>

    <delete file="${timewindow.end.filename}"/>
  </target>

</project>
